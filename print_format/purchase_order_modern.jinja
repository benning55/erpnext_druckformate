{% set company = frappe.get_doc("Company", doc.company) %}
{% set company_address_name = frappe.db.get_value("Dynamic Link", filters={"link_doctype": "Company", "link_name": doc.company, "parenttype": "Address"}, fieldname="parent") %}
{% set cmp_addr = frappe.get_doc("Address", company_address_name) if company_address_name else None %}
{% set sup_addr = frappe.get_doc("Address", doc.supplier_address) if doc.supplier_address else None %}
{% if doc.contact_person %}
    {% set contact = frappe.get_doc("Contact", doc.contact_person) %}
{% endif %}

<!-- Force disable standard letterhead -->
{% set no_letterhead = 1 %}

<style>
    /* --------------------------------------------------------
       GLOBAL RESET & PAGE SETUP
       -------------------------------------------------------- */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    html, body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        background: white;
    }

    @media print {
        @page {
            /* Reduced margins to better fit the content */
            size: A4;
            margin: 5mm; 
        }
        
        body {
            width: 100%;
        }

        /* Hide ERPNext defaults */
        .print-heading, .letter-head, .footer, #header-html, #footer-html {
            display: none !important;
        }
        
        /* Force background colors */
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .footer-blue-bar {
            background-color: #003d7a !important;
            color: white !important;
        }
        
        .footer-blue-bar * {
            color: white !important;
        }
    }

    /* --------------------------------------------------------
       MAIN LAYOUT TABLE
       -------------------------------------------------------- */
    .layout-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
    }

    .layout-table thead {
        display: table-header-group;
    }

    .layout-table tfoot {
        display: table-footer-group;
    }

    /* Ensure rows don't break awkwardly */
    .layout-table tr {
        page-break-inside: avoid;
    }

    .layout-table td {
        vertical-align: top;
    }

    /* --------------------------------------------------------
       HEADER CONTENT
       -------------------------------------------------------- */
    .header-content {
        height: 35mm;
        background-color: #003d7a;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        padding: 0 10mm; /* Inner padding matches visual design */
        margin-bottom: 10mm; /* Space before body content */
    }

    .header-logo-container {
        background-color: white;
        padding: 3mm;
        border-radius: 2px;
        margin-top: 5mm;
    }

    .header-logo {
        height: 20mm;
        width: auto;
        display: block;
    }

    /* --------------------------------------------------------
       BODY CONTENT
       -------------------------------------------------------- */
    .content-wrapper {
        padding: 0 10mm; /* Match header/footer alignment */
    }

    .address-area {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10mm;
        align-items: flex-start;
    }

    .address-left { width: 45%; }
    .address-right { width: 50%; }

    .sender-line {
        font-size: 7pt;
        text-decoration: underline;
        margin-bottom: 3mm;
        color: #000;
    }

    .address-block {
        margin-bottom: 5mm;
        line-height: 1.4;
        font-size: 10pt;
    }

    .doc-info-header {
        background-color: #e6e6e6;
        padding: 2mm 3mm;
        display: flex;
        justify-content: space-between;
        font-weight: bold;
        font-size: 11pt;
        margin-bottom: 3mm;
    }

    .doc-info-table {
        width: 100%;
        font-size: 9pt;
        border-collapse: collapse;
    }
    .doc-info-table td { padding: 1.5mm 0; }
    .doc-info-table td:last-child { text-align: right; font-weight: bold; }

    .payment-note {
        margin-top: 4mm;
        border-top: 1px solid black;
        border-bottom: 1px solid black;
        padding: 2mm;
        text-align: center;
        font-weight: bold;
        font-size: 9pt;
    }

    /* Items Table */
    .items-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 5mm;
        font-size: 9pt;
    }

    .items-table thead {
        display: table-header-group;
    }

    .items-table thead th {
        border-top: 1px solid black;
        border-bottom: 1px solid black;
        padding: 2mm 1mm;
        text-align: left;
        background-color: white;
    }

    .items-table tbody td {
        padding: 2mm 1mm;
        border-bottom: 1px solid #eee;
        vertical-align: top;
    }
    
    .items-table tr {
        page-break-inside: avoid;
    }

    .text-right { text-align: right; }

    /* Totals */
    .totals-area {
        margin-top: 5mm;
        display: flex;
        justify-content: flex-end;
        page-break-inside: avoid;
    }

    .totals-table {
        width: 50%;
        border-collapse: collapse;
        font-size: 10pt;
    }
    .totals-table td { padding: 2mm 0; }
    .totals-table tr.grand-total td {
        border-top: 1px solid black;
        border-bottom: 2px solid black;
        font-weight: bold;
        padding-top: 2mm;
    }

    /* --------------------------------------------------------
       FOOTER CONTENT
       -------------------------------------------------------- */
    .footer-content {
        margin-top: 10mm; /* Space above footer */
    }

    .page-number {
        text-align: right;
        font-size: 9pt;
        margin-bottom: 2mm;
        padding-right: 10mm;
    }

    .footer-blue-bar {
        background-color: #003d7a !important;
        color: white !important;
        padding: 5mm 10mm; /* Inner padding matches header */
        font-size: 8pt;
        display: flex;
        justify-content: space-between;
        min-height: 35mm;
        -webkit-print-color-adjust: exact; 
        print-color-adjust: exact;
    }

    .footer-col { width: 32%; }
    .footer-col strong {
        display: block;
        margin-bottom: 2mm;
        font-size: 9pt;
        border-bottom: 1px solid rgba(255,255,255,0.3);
        padding-bottom: 1mm;
        color: white !important;
    }
    .footer-col p { margin: 0.5mm 0; line-height: 1.3; color: white !important; }

</style>

<table class="layout-table">
    <thead>
        <tr>
            <td>
                <div class="header-content">
                    <div class="header-logo-container">
                        <img src="/files/TMONITLogo.png" class="header-logo" alt="Logo">
                    </div>
                </div>
            </td>
        </tr>
    </thead>

    <tbody>
        <tr>
            <td>
                <div class="content-wrapper">
                    <!-- Address Row -->
                    <div class="address-area">
                        <div class="address-left">
                            <div class="sender-line">TMONIT - Hauptstraße 123 - 10115 Berlin</div>
                            <div class="address-block">
                                <div style="font-weight: bold; margin-bottom: 2mm;">{{ _("Invoice Address") }}</div>
                                <strong>{{ doc.supplier }}</strong><br>
                                {% if contact %}
                                    {{ contact.first_name }} {{ contact.last_name }}<br>
                                {% endif %}
                                {{ doc.address_display or "" }}
                            </div>
                            
                            {% if doc.shipping_address_display %}
                            <div class="address-block" style="margin-top: 5mm;">
                                <div style="font-weight: bold; margin-bottom: 2mm;">{{ _("Shipping Address") }}</div>
                                {{ doc.shipping_address_display }}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="address-right">
                            <div class="doc-info-header">
                                <span>{{ _("Purchase Order") }}</span>
                                <span>{{ frappe.utils.formatdate(doc.transaction_date, "dd.MM.yyyy") }}</span>
                            </div>
                            
                            <table class="doc-info-table">
                                <tr>
                                    <td>{{ _("PO Number") }}:</td>
                                    <td>{{ doc.name }}</td>
                                </tr>
                                <tr>
                                    <td>{{ _("Customer No.") }}:</td>
                                    <td>{{ doc.supplier or "-" }}</td>
                                </tr>
                                <tr>
                                    <td>{{ _("Contact Person") }}:</td>
                                    <td>
                                        {% if contact %}
                                            {{ contact.first_name }} {{ contact.last_name }}
                                        {% else %}
                                            {{ doc.owner }}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% if doc.schedule_date %}
                                <tr>
                                    <td>{{ _("Delivery Date") }}:</td>
                                    <td>{{ frappe.utils.formatdate(doc.schedule_date, "dd.MM.yyyy") }}</td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <td>{{ _("Payment Terms") }}:</td>
                                    <td>{{ doc.payment_terms_template or "Standard" }}</td>
                                </tr>
                            </table>
                            
                            <div class="payment-note">
                                {{ _("Payment in advance on order") }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Items Table -->
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th style="width: 5%;">{{ _("Pos.") }}</th>
                                <th style="width: 50%;">{{ _("Description") }}</th>
                                <th style="width: 10%;">{{ _("Qty") }}</th>
                                <th style="width: 10%;">{{ _("Unit") }}</th>
                                <th style="width: 12%;" class="text-right">{{ _("Price") }}</th>
                                <th style="width: 13%;" class="text-right">{{ _("Total") }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in doc.items %}
                            <tr>
                                <td>{{ loop.index }}.</td>
                                <td>
                                    <strong>{{ item.item_code }}</strong>
                                    {% if item.item_name != item.item_code %}<br>{{ item.item_name }}{% endif %}
                                    {% if item.description %}
                                    <div style="font-size: 8.5pt; color: #555; margin-top: 1mm;">
                                        {{ item.description }}
                                    </div>
                                    {% endif %}
                                </td>
                                <td>{{ item.get_formatted("qty") }}</td>
                                <td>{{ item.uom }}</td>
                                <td class="text-right">{{ item.get_formatted("rate") }}</td>
                                <td class="text-right">{{ item.get_formatted("amount") }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    <!-- Totals -->
                    <div class="totals-area">
                        <table class="totals-table">
                            <tr>
                                <td>{{ _("Net Total") }}</td>
                                <td class="text-right">{{ doc.get_formatted("net_total") }}</td>
                            </tr>
                            {% for tax in doc.taxes %}
                            {% if tax.tax_amount %}
                            <tr>
                                <td>{{ tax.description }}</td>
                                <td class="text-right">{{ tax.get_formatted("tax_amount") }}</td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                            <tr class="grand-total">
                                <td>{{ _("Total Amount") }}</td>
                                <td class="text-right">{{ doc.get_formatted("grand_total") }}</td>
                            </tr>
                        </table>
                    </div>
                    
                    {% if doc.terms %}
                    <div style="margin-top: 10mm; font-size: 9pt;">
                        <strong>{{ _("Terms and Conditions") }}:</strong><br>
                        {{ doc.terms }}
                    </div>
                    {% endif %}
                </div>
            </td>
        </tr>
    </tbody>

    <tfoot>
        <tr>
            <td>
                <div class="footer-content">
                    <div class="page-number">
                        - Seite 1 von 1 -
                    </div>
                    <div class="footer-blue-bar">
                        <div class="footer-col">
                            <strong>TMONIT</strong>
                            <p>Hauptstraße 123</p>
                            <p>10115 Berlin</p>
                            <p>Tel: +49 30 12345678</p>
                            <p>Email: info@tmonit.com</p>
                        </div>
                        <div class="footer-col">
                            <strong>{{ _("Legal Info") }}</strong>
                            <p>{{ _("Tax ID") }}: DE123456789</p>
                            <p>{{ _("Reg. No.") }}: HRB 12345</p>
                            <p>Amtsgericht Berlin</p>
                        </div>
                        <div class="footer-col">
                            <strong>{{ _("Bank Details") }}</strong>
                            <p>Deutsche Bank</p>
                            <p>IBAN: DE89 1234 5678 9012 3456 78</p>
                            <p>BIC: DEUTDEFF</p>
                        </div>
                    </div>
                </div>
            </td>
        </tr>
    </tfoot>
</table>
