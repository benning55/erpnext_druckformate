{% set company = frappe.get_doc("Company", doc.company) %}
{% set company_address_name = frappe.db.get_value("Dynamic Link", filters={"link_doctype": "Company", "link_name": doc.company, "parenttype": "Address"}, fieldname="parent") %}
{% set cmp_addr = frappe.get_doc("Address", company_address_name) if company_address_name else None %}
{% set sup_addr = frappe.get_doc("Address", doc.supplier_address) if doc.supplier_address else None %}
{% if doc.contact_person %}
    {% set contact = frappe.get_doc("Contact", doc.contact_person) %}
{% endif %}

{% set no_letterhead = 1 %}

<style>
    *, html, body {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    body {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 9pt;
        line-height: 1.3;
        color: #000;
        background: white;
        width: 100%;
    }
    @media print {
        @page {
            size: A4 portrait;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        body {
            width: 210mm;
            margin: 0 !important;
            padding: 0 !important;
        }
        .print-heading, .letter-head, .footer, #header-html, #footer-html, .page-break {
            display: none !important;
        }
        
        .print-format {
            padding: 0 !important;
            margin: 0 !important;
            min-height: 0 !important; 
            height: auto !important;
        }

        thead { display: table-header-group; }
        tfoot { display: table-footer-group; }
        
        tr { page-break-inside: avoid; }
        .address-row, .summary-section { page-break-inside: avoid; }
    }
    :root {
        --primary-blue: #00457f;
        --separator-red: #c00000;
        --text-grey: #666;
    }
    .header-fixed {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 50px;
        background-color: var(--primary-blue);
        border-bottom: 2px solid var(--separator-red);
        z-index: 1000;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        padding: 0 12mm;
    }

    .header-logo {
        height: 35px;
        width: auto;
        background: white; 
        padding: 2px;
    }
    .footer-fixed {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 40mm;
        background: white;
        z-index: 1000;
    }

    .page-number-container {
        text-align: center;
        font-size: 8pt;
        height: 5mm;
        line-height: 5mm;
    }
    .page-number::after {
        content: counter(page);
    }

    .footer-blue-bar {
        border-top: 1px solid black;
        color: white !important;
        padding: 4mm 12mm;
        height: 30mm;
        font-size: 7.5pt;
        display: flex;
        justify-content: space-between;
        margin-top: 2mm;
    }

    .footer-col {
        width: 32%;
    }
    .footer-col p { margin-bottom: 1px; color: black !important; }
    .footer-col strong { display: block; margin-bottom: 2px; font-weight: bold; color: black !important; }

    .header-spacer {
        height: 50px;
        margin-bottom: 1rem;
    }

    .footer-spacer {
        height: 35mm;
    }
    .main-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .main-table td {
        padding: 0;
        vertical-align: top;
    }

    .content-inner {
        padding: 0 12mm;
        width: 100%;
    }

    .top-address-line {
        font-size: 7pt;
        color: var(--text-grey);
        margin-bottom: 5mm;
    }

    .address-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10mm;
    }

    .col-left { width: 55%; padding-right: 5mm; }
    .col-right { width: 45%; }

    .address-block {
        margin-bottom: 5mm;
        font-size: 10pt;
    }
    .address-label { font-weight: bold; display: block; margin-bottom: 1mm; font-size: 9pt; }
    .info-box-header {
        background-color: #eee;
        padding: 2mm 3mm;
        font-weight: bold;
        font-size: 11pt;
        display: flex;
        justify-content: space-between;
        margin-bottom: 2mm;
    }

    .info-table {
        width: 100%;
        font-size: 8pt; /* Reduced font size */
        border-collapse: collapse;
    }
    .info-table td {
        padding: 0.5mm 0; /* Reduced padding */
        vertical-align: top;
        line-height: 1.2; /* Tighter line height */
    }
    .info-table td:first-child { width: 50%; }
    .info-table td:last-child { text-align: right; font-weight: bold; }

    .payment-note {
        border-top: 1px solid #000;
        border-bottom: 1px solid #000;
        text-align: center;
        padding: 2mm;
        font-weight: bold;
        margin-top: 4mm;
    }
    .delivery-line {
        text-align: center;
        font-weight: bold;
        margin: 5mm 0;
    }
    .items-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 5mm;
        font-size: 9pt;
    }

    .items-table thead th {
        border-top: 2px solid #000;
        border-bottom: 2px solid #000;
        padding: 2mm 1mm;
        text-align: left;
        font-weight: bold;
        background: white;
    }

    .bd-right { border-right: 2px solid #000; }

    .th-left, .td-left { text-align: left !important; }
    .th-right, .td-right { text-align: right !important; }
    .th-center, .td-center { text-align: center !important; }
    
    .items-table tbody td {
        padding: 2mm 1mm;
        border-bottom: 1px solid #ddd; /* Light separator */
        vertical-align: top;
    }

    .item-code { font-weight: bold; display: block; }
    .item-desc { display: block; margin-top: 1mm; color: #333; }
    .summary-section {
        margin-top: 10mm;
    }

    .totals-grid {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }

    .totals-header-row {
        display: flex;
        border-bottom: 1px solid #000;
        font-weight: bold;
        padding-bottom: 1mm;
        margin-bottom: 1mm;
        width: 100%;
        justify-content: flex-end;
        gap: 5mm;
    }

    .totals-value-row {
        display: flex;
        width: 100%;
        justify-content: flex-end;
        gap: 5mm;
        margin-bottom: 3mm;
    }

    .total-col {
        width: 25mm;
        text-align: right;
    }

    .grand-total-label {
        text-align: center;
        font-weight: bold;
        font-size: 10pt;
    }
    
    .grand-total-value {
        text-align: center;
        font-weight: bold;
        font-size: 11pt;
        margin-top: 1mm;
    }
    .closing-text {
        margin-top: 10mm;
        font-size: 8pt;
        color: #444;
    }
    .thanks-text {
        margin-top: 5mm;
        font-size: 10pt;
    }

</style>

<div class="header-fixed">
    <div class="header-content" style="width: 100%; display: flex; justify-content: flex-end; align-items: center; height: 100%;">
        <img src="/files/TMONITLogo.png" class="header-logo" alt="Logo">
    </div>
</div>

<div class="footer-fixed">
    <div class="page-number-container">
        – {{ _("Page") }} <span class="page-number"></span> –
    </div>
    <div class="footer-blue-bar">
        <div class="footer-col">
            <strong>{{ _("Address") }}</strong>
            <p>Tmonit UG</p>
            <p>Birkenstraße 69</p>
            <p>10559 Berlin</p>
            <p>DE365570629</p>
        </div>
        <div class="footer-col">
            <strong>{{ _("Bank Connection") }}</strong>
            <p>Postbank Berlin</p>
            <p>DE37 1007 0397 0075 0620 00</p>
            <p>PBNKDEFFXXX</p>
        </div>
        <div class="footer-col">
            <strong>{{ _("Contact") }}</strong>
            <p>+49 30 48810374</p>
            <p>info@t-monit.de</p>
            <p>www.t-monit.de</p>
        </div>
    </div>
</div>

<table class="main-table">
    <thead>
        <tr>
            <td>
                <div class="header-spacer"></div>
            </td>
        </tr>
    </thead>

    <tfoot>
        <tr>
            <td>
                <div class="footer-spacer"></div>
            </td>
        </tr>
    </tfoot>

    <tbody>
        <tr>
            <td>
                <div class="content-inner">
                    
                    <div class="top-address-line">
                        Tmonit UG • Birkenstraße 69 • 10559 Berlin • Germany
                    </div>
                    <div class="address-row">
                        <div class="col-left">
                            <div class="address-block">
                                <span class="address-label">{{ _("Billing Address") }}:</span>
                                <strong>{{ doc.supplier }}</strong><br>
                                {% if contact %}
                                    {{ contact.first_name }} {{ contact.last_name }}<br>
                                {% endif %}
                                {{ doc.address_display or "" }}
                            </div>

                            {% if doc.shipping_address_name %}
                            <div class="address-block">
                                <span class="address-label">{{ _("Shipping Address") }}:</span>
                                {{ doc.shipping_address_display }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="col-right">
                            <div class="info-box-header">
                                <span>{{ _("Purchase Order") }}</span>
                                <span>Berlin, {{ frappe.utils.formatdate(doc.transaction_date, "dd.MM.yyyy") }}</span>
                            </div>

                            <table class="info-table">
                                <tr>
                                    <td>{{ _("Order No.") }}:</td>
                                    <td>{{ doc.name }}</td>
                                </tr>
                                <tr>
                                    <td>{{ _("Supplier No.") }}:</td>
                                    <td>{{ doc.supplier or "-" }}</td>
                                </tr>
                                <tr>
                                    <td>{{ _("Your Contact") }}:</td>
                                    <td>
                                        {% if contact %}
                                            {{ contact.first_name }} {{ contact.last_name }}
                                        {% else %}
                                            {{ doc.owner }}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% if doc.supplier_reference %}
                                <tr>
                                    <td>{{ _("Your Reference") }}:</td>
                                    <td>{{ doc.supplier_reference }}</td>
                                </tr>
                                {% endif %}
                                {% if doc.tax_id %}
                                <tr>
                                    <td>{{ _("Your VAT ID") }}:</td>
                                    <td>{{ doc.tax_id }}</td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <td>{{ _("Shipping Method") }}:</td>
                                    <td>{{ doc.shipping_method or "Standard" }}</td>
                                </tr>
                                <tr>
                                    <td>{{ _("Payment Terms") }}:</td>
                                    <td>{{ doc.payment_terms_template or "Standard" }}</td>
                                </tr>
                            </table>

                            {# <div class="payment-note">
                                {{ _("Payment in advance upon order placement") }}
                            </div> #}
                        </div>
                    </div>

                    <div class="delivery-line">
                        {{ _("Delivery according to order") }}
                    </div>

                    <table class="items-table">
                        <thead>
                            <tr>
                                <th style="width: 5%;">{{ _("Pos.") }}</th>
                                <th style="width: 45%;">{{ _("Description") }}</th>
                                <th style="width: 10%;" class="th-left">{{ _("Qty") }}</th>
                                <th style="width: 10%;" class="th-left">{{ _("Unit") }}</th>
                                <th style="width: 15%;" class="th-left">{{ _("Unit Price") }} €</th>
                                <th style="width: 15%;" class="th-left">{{ _("Total Price") }} €</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in doc.items %}
                            <tr>
                                <td>{{ loop.index }}.</td>
                                <td>
                                    <span class="item-code">{{ item.item_code }}</span>
                                    <span class="item-desc">{{ item.item_name }}</span>
                                    {% if item.description and item.description != item.item_name %}
                                        <div style="font-size: 8.5pt; color: #666; margin-top: 2px; white-space: pre-wrap;">{{ item.description }}</div>
                                    {% endif %}
                                </td>
                                <td class="td-left">{{ item.get_formatted("qty") }}</td>
                                <td class="td-left">{{ item.uom }}</td>
                                <td class="td-left">{{ item.get_formatted("rate") }}</td>
                                <td class="td-left">{{ item.get_formatted("amount") }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <div class="summary-section">
                        <div style="border-bottom: 1px solid #000; margin-bottom: 5mm; padding-bottom: 2mm;">
                            <div style="display: flex; justify-content: space-between; font-size: 9pt; color: #666;">
                                <span>{{ _("Billing Address") }}: {{ doc.supplier }}</span>
                                <span>{{ _("Shipping Address") }}: {{ doc.shipping_address_name or doc.supplier }}</span>
                            </div>
                        </div>

                        <div style="text-align: right; margin-bottom: 5mm; font-weight: bold;">
                            {{ _("Total (Net)") }}: {{ doc.get_formatted("net_total") }}
                        </div>

                        <div class="totals-grid">
                            <div class="totals-header-row">
                                <div class="total-col">{{ _("Net") }} (€)</div>
                                <div class="total-col">{{ _("VAT") }} %</div>
                                <div class="total-col">{{ _("VAT Amt") }}</div>
                                <div class="total-col">{{ _("Gross") }} (€)</div>
                            </div>

                            <div class="totals-value-row">
                                <div class="total-col">{{ doc.get_formatted("net_total") }}</div>
                                <div class="total-col">
                                    {% if doc.taxes and doc.taxes[0] %}
                                        {{ doc.taxes[0].rate }} %
                                    {% else %}
                                        0 %
                                    {% endif %}
                                </div>
                                <div class="total-col">{{ doc.get_formatted("total_taxes_and_charges") }}</div>
                                <div class="total-col">{{ doc.get_formatted("grand_total") }}</div>
                            </div>
                        </div>

                        <div style="display: flex; justify-content: flex-end; align-items: center; gap: 5mm;">
                            <div class="grand-total-label">{{ _("Total Amount") }}</div>
                            <div class="grand-total-value">{{ doc.get_formatted("grand_total") }}</div>
                        </div>
                    </div>

                    {# <div class="closing-text">
                        <p>{{ _("The goods remain the property of the supplier until full payment.") }}</p>
                        <p>{{ _("Our general terms and conditions apply, viewable at") }} https://t-monit.de/.</p>
                    </div>

                    <div class="thanks-text">
                        {{ _("Thank you for your order.") }}
                    </div> #}

                </div>
            </td>
        </tr>
    </tbody>
</table>
