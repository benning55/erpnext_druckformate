{% set company = frappe.get_doc("Company", doc.company) %}
{% set company_address_name = frappe.db.get_value("Dynamic Link", filters={"link_doctype": "Company", "link_name": doc.company, "parenttype": "Address"}, fieldname="parent") %}
{% set cmp_addr = frappe.get_doc("Address", company_address_name) if company_address_name else None %}
{% set sup_addr = frappe.get_doc("Address", doc.supplier_address) if doc.supplier_address else None %}
{% if doc.contact_person %}
    {% set contact = frappe.get_doc("Contact", doc.contact_person) %}
{% endif %}

<!-- Force disable standard letterhead -->
{% set no_letterhead = 1 %}

<style>
    /* 
       1. GLOBAL RESET & TYPOGRAPHY 
    */
    *, html, body {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    body {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 9pt;
        line-height: 1.3;
        color: #000;
        background: white;
        width: 100%;
    }

    /* 
       2. PRINT MEDIA SETTINGS (Chrome Headless) 
    */
    @media print {
        @page {
            size: A4 portrait;
            margin: 0; /* Full bleed for header/footer */
        }
        
        body {
            width: 210mm; /* A4 width */
        }

        /* Hide standard Frappe/ERPNext elements */
        .print-heading, .letter-head, .footer, #header-html, #footer-html, .page-break {
            display: none !important;
        }
        
        .print-format {
            padding: 0 !important;
            margin: 0 !important;
            min-height: 0 !important; 
            height: auto !important;
        }

        /* Repeat headers/footers in table */
        thead { display: table-header-group; }
        tfoot { display: table-footer-group; }
        
        /* Prevent breaks inside elements */
        tr { page-break-inside: avoid; }
        .address-row, .summary-section { page-break-inside: avoid; }
    }

    /* 
       3. VISUAL ELEMENTS (Fixed Position) 
    */
    :root {
        --primary-blue: #00457f;
        --separator-red: #c00000;
        --text-grey: #666;
    }

    /* Header Visual */
    .header-fixed {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 50px;
        background-color: var(--primary-blue);
        border-bottom: 2px solid var(--separator-red);
        z-index: 1000;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        padding: 0 12mm;
    }

    .header-logo {
        height: 35px;
        width: auto;
        background: white; 
        padding: 2px;
    }

    /* Footer Visual */
    .footer-fixed {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 35mm;
        background: white;
        z-index: 1000;
    }

    .page-number-container {
        text-align: center;
        font-size: 8pt;
        height: 5mm;
        line-height: 5mm;
    }
    
    /* CSS Counter for Page Numbers */
    .page-number::after {
        content: counter(page);
    }

    .footer-blue-bar {
        background-color: var(--primary-blue);
        border-top: 2px solid var(--separator-red);
        color: white;
        padding: 4mm 12mm;
        height: 30mm;
        font-size: 7.5pt;
        display: flex;
        justify-content: space-between;
    }

    .footer-col {
        width: 32%;
    }
    .footer-col p { margin-bottom: 1px; }
    .footer-col strong { display: block; margin-bottom: 2px; font-weight: bold; }

    /* 
       4. SPACERS (To reserve space on every page) 
    */
    .header-spacer {
        height: 50px; /* Must match .header-fixed height */
        /* Margin to push content down on every page */
        margin-bottom: 1rem;
    }

    .footer-spacer {
        height: 35mm; /* Must match .footer-fixed height */
    }

    /* 
       5. CONTENT LAYOUT 
    */
    .main-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .main-table td {
        padding: 0;
        vertical-align: top;
    }

    .content-inner {
        padding: 0 12mm; /* Left/Right margins for text */
        width: 100%;
    }

    /* Top Address Section */
    .top-address-line {
        font-size: 7pt;
        color: var(--text-grey);
        margin-bottom: 5mm;
    }

    .address-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10mm;
    }

    .col-left { width: 55%; padding-right: 5mm; }
    .col-right { width: 45%; }

    .address-block {
        margin-bottom: 5mm;
        font-size: 10pt;
    }
    .address-label { font-weight: bold; display: block; margin-bottom: 1mm; font-size: 9pt; }

    /* Info Box (Right Side) */
    .info-box-header {
        background-color: #eee;
        padding: 2mm 3mm;
        font-weight: bold;
        font-size: 11pt;
        display: flex;
        justify-content: space-between;
        margin-bottom: 2mm;
    }

    .info-table {
        width: 100%;
        font-size: 9pt;
        border-collapse: collapse;
    }
    .info-table td {
        padding: 1mm 0;
        vertical-align: top;
    }
    .info-table td:first-child { width: 50%; }
    .info-table td:last-child { text-align: right; font-weight: bold; }

    .payment-note {
        border-top: 1px solid #000;
        border-bottom: 1px solid #000;
        text-align: center;
        padding: 2mm;
        font-weight: bold;
        margin-top: 4mm;
    }

    /* Delivery Note Line */
    .delivery-line {
        text-align: center;
        font-weight: bold;
        margin: 5mm 0;
    }

    /* 
       6. ITEMS TABLE 
    */
    .items-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 5mm;
        font-size: 9pt;
    }

    .items-table thead th {
        border-top: 2px solid #000;
        border-bottom: 2px solid #000;
        padding: 2mm 1mm;
        text-align: left;
        font-weight: bold;
        background: white; /* Prevent transparent header issue */
    }

    /* Column Alignment */
    .th-right, .td-right { text-align: right; }
    .th-center, .td-center { text-align: center; }
    
    .items-table tbody td {
        padding: 2mm 1mm;
        border-bottom: 1px solid #ddd; /* Light separator */
        vertical-align: top;
    }

    .item-code { font-weight: bold; display: block; }
    .item-desc { display: block; margin-top: 1mm; color: #333; }

    /* 
       7. TOTALS SECTION 
    */
    .summary-section {
        margin-top: 10mm;
    }

    .totals-grid {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }

    .totals-header-row {
        display: flex;
        border-bottom: 1px solid #000;
        font-weight: bold;
        padding-bottom: 1mm;
        margin-bottom: 1mm;
        width: 100%;
        justify-content: flex-end;
        gap: 5mm;
    }

    .totals-value-row {
        display: flex;
        width: 100%;
        justify-content: flex-end;
        gap: 5mm;
        margin-bottom: 3mm;
    }

    .total-col {
        width: 25mm;
        text-align: right;
    }

    .grand-total-label {
        text-align: center;
        font-weight: bold;
        margin-top: 3mm;
        font-size: 10pt;
    }
    
    .grand-total-value {
        text-align: center;
        font-weight: bold;
        font-size: 11pt;
        margin-top: 1mm;
    }

    /* 
       8. CLOSING TEXT 
    */
    .closing-text {
        margin-top: 10mm;
        font-size: 8pt;
        color: #444;
    }
    .thanks-text {
        margin-top: 5mm;
        font-size: 10pt;
    }

</style>

<!-- FIXED HEADER (Visual Only) -->
<div class="header-fixed">
    <div class="header-content" style="width: 100%; display: flex; justify-content: flex-end; align-items: center; height: 100%;">
        <img src="/files/TMONITLogo.png" class="header-logo" alt="Logo">
    </div>
</div>

<!-- FIXED FOOTER (Visual Only) -->
<div class="footer-fixed">
    <div class="page-number-container">
        – {{ _("Page") }} <span class="page-number"></span> –
    </div>
    <div class="footer-blue-bar">
        <div class="footer-col">
            <strong>TMONIT</strong>
            <p>Hauptstraße 123</p>
            <p>10115 Berlin</p>
            <p>{{ _("Tel") }}: +49 30 12345678</p>
            <p>{{ _("Email") }}: info@tmonit.com</p>
            <p>{{ _("Web") }}: www.tmonit.com</p>
        </div>
        <div class="footer-col">
            <strong>{{ _("Legal Information") }}</strong>
            <p>{{ _("VAT ID") }}: DE123456789</p>
            <p>{{ _("Commercial Register") }}: HRB 12345</p>
            <p>{{ _("Court of Registration") }}: Berlin</p>
            <p>{{ _("Managing Director") }}: Max Mustermann</p>
        </div>
        <div class="footer-col">
            <strong>{{ _("Bank Details") }}</strong>
            <p>Deutsche Bank</p>
            <p>{{ _("IBAN") }}: DE89 1234 5678 9012 3456 78</p>
            <p>{{ _("BIC") }}: DEUTDEFF</p>
            <div style="margin-top: 2mm; width: 10mm; height: 10mm; border: 1px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 5pt;">
                ISO
            </div>
        </div>
    </div>
</div>

<!-- MAIN LAYOUT TABLE (Handles Spacing per Page) -->
<table class="main-table">
    <!-- HEADER SPACER: Reserves space at top of EVERY page -->
    <thead>
        <tr>
            <td>
                <div class="header-spacer"></div>
            </td>
        </tr>
    </thead>

    <!-- FOOTER SPACER: Reserves space at bottom of EVERY page -->
    <tfoot>
        <tr>
            <td>
                <div class="footer-spacer"></div>
            </td>
        </tr>
    </tfoot>

    <!-- CONTENT BODY -->
    <tbody>
        <tr>
            <td>
                <div class="content-inner">
                    
                    <!-- 1. TOP META LINE -->
                    <div class="top-address-line">
                        TMONIT • Hauptstraße 123 • 10115 Berlin
                    </div>

                    <!-- 2. TWO COLUMN INFO BLOCK -->
                    <div class="address-row">
                        <!-- LEFT: ADDRESSES -->
                        <div class="col-left">
                            <div class="address-block">
                                <span class="address-label">{{ _("Billing Address") }}:</span>
                                <strong>{{ doc.supplier }}</strong><br>
                                {% if contact %}
                                    {{ contact.first_name }} {{ contact.last_name }}<br>
                                {% endif %}
                                {{ doc.address_display or "" }}
                            </div>

                            {% if doc.shipping_address_name %}
                            <div class="address-block">
                                <span class="address-label">{{ _("Shipping Address") }}:</span>
                                {{ doc.shipping_address_display }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- RIGHT: INFO BAR & TABLE -->
                        <div class="col-right">
                            <div class="info-box-header">
                                <span>{{ _("Purchase Order") }}</span>
                                <span>Berlin, {{ frappe.utils.formatdate(doc.transaction_date, "dd.MM.yyyy") }}</span>
                            </div>

                            <table class="info-table">
                                <tr>
                                    <td>{{ _("Order No.") }}:</td>
                                    <td>{{ doc.name }}</td>
                                </tr>
                                <tr>
                                    <td>{{ _("Supplier No.") }}:</td>
                                    <td>{{ doc.supplier or "-" }}</td>
                                </tr>
                                <tr>
                                    <td>{{ _("Your Contact") }}:</td>
                                    <td>
                                        {% if contact %}
                                            {{ contact.first_name }} {{ contact.last_name }}
                                        {% else %}
                                            {{ doc.owner }}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% if doc.supplier_reference %}
                                <tr>
                                    <td>{{ _("Your Reference") }}:</td>
                                    <td>{{ doc.supplier_reference }}</td>
                                </tr>
                                {% endif %}
                                {% if doc.tax_id %}
                                <tr>
                                    <td>{{ _("Your VAT ID") }}:</td>
                                    <td>{{ doc.tax_id }}</td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <td>{{ _("Shipping Method") }}:</td>
                                    <td>{{ doc.shipping_method or "Standard" }}</td>
                                </tr>
                                <tr>
                                    <td>{{ _("Payment Terms") }}:</td>
                                    <td>{{ doc.payment_terms_template or "Standard" }}</td>
                                </tr>
                            </table>

                            <div class="payment-note">
                                {{ _("Payment in advance upon order placement") }}
                            </div>
                        </div>
                    </div>

                    <!-- 3. DELIVERY NOTE LINE -->
                    <div class="delivery-line">
                        {{ _("Delivery according to order") }}
                    </div>

                    <!-- 4. ITEMS TABLE -->
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th style="width: 5%;">{{ _("Pos.") }}</th>
                                <th style="width: 45%;">{{ _("Description") }}</th>
                                <th style="width: 10%;" class="th-right">{{ _("Qty") }}</th>
                                <th style="width: 10%;" class="th-center">{{ _("Unit") }}</th>
                                <th style="width: 15%;" class="th-right">{{ _("Unit Price") }} €</th>
                                <th style="width: 15%;" class="th-right">{{ _("Total Price") }} €</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in doc.items %}
                            <tr>
                                <td>{{ loop.index }}.</td>
                                <td>
                                    <span class="item-code">{{ item.item_code }}</span>
                                    <span class="item-desc">{{ item.item_name }}</span>
                                    {% if item.description and item.description != item.item_name %}
                                        <div style="font-size: 8.5pt; color: #666; margin-top: 2px; white-space: pre-wrap;">{{ item.description }}</div>
                                    {% endif %}
                                </td>
                                <td class="td-right">{{ item.get_formatted("qty") }}</td>
                                <td class="td-center">{{ item.uom }}</td>
                                <td class="td-right">{{ item.get_formatted("rate") }}</td>
                                <td class="td-right">{{ item.get_formatted("amount") }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <!-- 5. SUMMARY & TOTALS SECTION -->
                    <div class="summary-section">
                        <!-- Summary Header Block -->
                        <div style="border-bottom: 1px solid #000; margin-bottom: 5mm; padding-bottom: 2mm;">
                            <div style="display: flex; justify-content: space-between; font-size: 9pt; color: #666;">
                                <span>{{ _("Billing Address") }}: {{ doc.supplier }}</span>
                                <span>{{ _("Shipping Address") }}: {{ doc.shipping_address_name or doc.supplier }}</span>
                            </div>
                        </div>

                        <div style="text-align: right; margin-bottom: 5mm; font-weight: bold;">
                            {{ _("Total (Net)") }}: {{ doc.get_formatted("net_total") }}
                        </div>

                        <!-- Tax Breakdown -->
                        <div class="totals-grid">
                            <div class="totals-header-row">
                                <div class="total-col">{{ _("Net") }} (€)</div>
                                <div class="total-col">{{ _("VAT") }} %</div>
                                <div class="total-col">{{ _("VAT Amt") }}</div>
                                <div class="total-col">{{ _("Gross") }} (€)</div>
                            </div>

                            <div class="totals-value-row">
                                <div class="total-col">{{ doc.get_formatted("net_total") }}</div>
                                <div class="total-col">
                                    {% if doc.taxes and doc.taxes[0] %}
                                        {{ doc.taxes[0].rate }} %
                                    {% else %}
                                        0 %
                                    {% endif %}
                                </div>
                                <div class="total-col">{{ doc.get_formatted("total_taxes_and_charges") }}</div>
                                <div class="total-col">{{ doc.get_formatted("grand_total") }}</div>
                            </div>
                        </div>

                        <div class="grand-total-label">{{ _("Invoice Amount") }}</div>
                        <div class="grand-total-value">{{ doc.get_formatted("grand_total") }}</div>
                    </div>

                    <!-- 6. CLOSING -->
                    <div class="closing-text">
                        <p>{{ _("The goods remain the property of the supplier until full payment.") }}</p>
                        <p>{{ _("Our general terms and conditions apply, viewable at") }} www.tmonit.com/agb.</p>
                    </div>

                    <div class="thanks-text">
                        {{ _("Thank you for your order.") }}
                    </div>

                </div>
            </td>
        </tr>
    </tbody>
</table>
